<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>5.21&nbsp;Exercise 5.21</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="racket.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript" src="manual-racket.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">zthomae&rsquo;s SICP solutions</a></td></tr></table></div><div class="tocviewsublisttop" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="Chapter_1.html" class="tocviewlink" data-pltdoc="x">Chapter 1</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="Chapter_2.html" class="tocviewlink" data-pltdoc="x">Chapter 2</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="Chapter_3.html" class="tocviewlink" data-pltdoc="x">Chapter 3</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="Chapter_4.html" class="tocviewlink" data-pltdoc="x">Chapter 4</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="Chapter_5.html" class="tocviewselflink" data-pltdoc="x">Chapter 5</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9660;</a></td><td>5&nbsp;</td><td><a href="Chapter_5.html" class="tocviewlink" data-pltdoc="x">Chapter 5</a></td></tr></table><div class="tocviewsublistbottom" style="display: block;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">5.1&nbsp;</td><td><a href="c5e0.html" class="tocviewlink" data-pltdoc="x">Note on diagrams</a></td></tr><tr><td align="right">5.2&nbsp;</td><td><a href="c5e2.html" class="tocviewlink" data-pltdoc="x">Exercise 5.2</a></td></tr><tr><td align="right">5.3&nbsp;</td><td><a href="c5e3.html" class="tocviewlink" data-pltdoc="x">Exercise 5.3</a></td></tr><tr><td align="right">5.4&nbsp;</td><td><a href="c5e4.html" class="tocviewlink" data-pltdoc="x">Exercise 5.4</a></td></tr><tr><td align="right">5.5&nbsp;</td><td><a href="c5e5.html" class="tocviewlink" data-pltdoc="x">Exercise 5.5</a></td></tr><tr><td align="right">5.6&nbsp;</td><td><a href="c5e6.html" class="tocviewlink" data-pltdoc="x">Exercise 5.6</a></td></tr><tr><td align="right">5.7&nbsp;</td><td><a href="c5e7.html" class="tocviewlink" data-pltdoc="x">Exercise 5.7</a></td></tr><tr><td align="right">5.8&nbsp;</td><td><a href="c5e8.html" class="tocviewlink" data-pltdoc="x">Exercise 5.8</a></td></tr><tr><td align="right">5.9&nbsp;</td><td><a href="c5e9.html" class="tocviewlink" data-pltdoc="x">Exercise 5.9</a></td></tr><tr><td align="right">5.10&nbsp;</td><td><a href="c5e10.html" class="tocviewlink" data-pltdoc="x">Exercise 5.10</a></td></tr><tr><td align="right">5.11&nbsp;</td><td><a href="c5e11.html" class="tocviewlink" data-pltdoc="x">Exercise 5.11</a></td></tr><tr><td align="right">5.12&nbsp;</td><td><a href="c5e12.html" class="tocviewlink" data-pltdoc="x">Exercise 5.12</a></td></tr><tr><td align="right">5.13&nbsp;</td><td><a href="c5e13.html" class="tocviewlink" data-pltdoc="x">Exercise 5.13</a></td></tr><tr><td align="right">5.14&nbsp;</td><td><a href="c5e14.html" class="tocviewlink" data-pltdoc="x">Exercise 5.14</a></td></tr><tr><td align="right">5.15&nbsp;</td><td><a href="c5e15.html" class="tocviewlink" data-pltdoc="x">Exercise 5.15</a></td></tr><tr><td align="right">5.16&nbsp;</td><td><a href="c5e16.html" class="tocviewlink" data-pltdoc="x">Exercise 5.16</a></td></tr><tr><td align="right">5.17&nbsp;</td><td><a href="c5e17.html" class="tocviewlink" data-pltdoc="x">Exercise 5.17</a></td></tr><tr><td align="right">5.18&nbsp;</td><td><a href="c5e18.html" class="tocviewlink" data-pltdoc="x">Exercise 5.18</a></td></tr><tr><td align="right">5.19&nbsp;</td><td><a href="c5e19.html" class="tocviewlink" data-pltdoc="x">Exercise 5.19</a></td></tr><tr><td align="right">5.20&nbsp;</td><td><a href="c5e20.html" class="tocviewlink" data-pltdoc="x">Exercise 5.20</a></td></tr><tr><td align="right">5.21&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Exercise 5.21</a></td></tr><tr><td align="right">5.22&nbsp;</td><td><a href="c5e22.html" class="tocviewlink" data-pltdoc="x">Exercise 5.22</a></td></tr><tr><td align="right">5.23&nbsp;</td><td><a href="c5e23.html" class="tocviewlink" data-pltdoc="x">Exercise 5.23</a></td></tr></table></div></div></div></div><div class="maincolumn"><div class="main"><div class="navsettop"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="c5e20.html" title="backward to &quot;5.20 Exercise 5.20&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="Chapter_5.html" title="up to &quot;5 Chapter 5&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="c5e22.html" title="forward to &quot;5.22 Exercise 5.22&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div><h4>5.21<tt>&nbsp;</tt><a name="(part._c5e21)"></a>Exercise 5.21</h4><p>Before I begin: I believe that the sentence "Assume that the list-structure memory
operations are available as machine primitives." is telling me that operations like
<span class="stt">null?</span>, <span class="stt">cons</span>, &amp;etc are already provided, <span style="font-style: italic">not</span> just <span class="stt">vector-ref</span>
&amp;etc.</p><p><span class="stt">count-leaves</span> is a little more complex than the other programs we&rsquo;ve written
so far because it has two recursive calls. We&rsquo;ve seen an example of this before,
but we&rsquo;ve never written an example ourselves.</p><p>First, we have a recursive implementation. This makes two recursive calls
in sequence and adds the results. For this to work, we need to save the return
value of the first call in order to add it to the return value of the second
call. The only other thing I&rsquo;d like to point out is that we only <span class="stt">save</span> the
<span class="stt">continue</span> register before making the first recursive call. There&rsquo;s no need
to do this after the second, because the destination would be the same.</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">count-leaves</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">cond</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">null?</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">not</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">pair?</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">1</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">else</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">+</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">count-leaves</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">car</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">count-leaves</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">cdr</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktSym">start-machine</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">assign</span><span class="hspace">&nbsp;</span><span class="RktSym">continue</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">label</span><span class="hspace">&nbsp;</span><span class="RktSym">count-leaves-done</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktSym">recurse-test</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">test</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">op</span><span class="hspace">&nbsp;</span><span class="RktSym">null?</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">reg</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">branch</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">label</span><span class="hspace">&nbsp;</span><span class="RktSym">base-case</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">test</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">op</span><span class="hspace">&nbsp;</span><span class="RktSym">pair?</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">reg</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">branch</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">label</span><span class="hspace">&nbsp;</span><span class="RktSym">recurse</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">assign</span><span class="hspace">&nbsp;</span><span class="RktSym">val</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="hspace">&nbsp;</span><span class="RktVal">1</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">goto</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">reg</span><span class="hspace">&nbsp;</span><span class="RktSym">continue</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktSym">recurse</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">save</span><span class="hspace">&nbsp;</span><span class="RktSym">continue</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">assign</span><span class="hspace">&nbsp;</span><span class="RktSym">continue</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">label</span><span class="hspace">&nbsp;</span><span class="RktSym">after-recurse-1</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">save</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">assign</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">op</span><span class="hspace">&nbsp;</span><span class="RktSym">car</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">reg</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">goto</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">label</span><span class="hspace">&nbsp;</span><span class="RktSym">recurse-test</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktSym">after-recurse-1</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">assign</span><span class="hspace">&nbsp;</span><span class="RktSym">continue</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">label</span><span class="hspace">&nbsp;</span><span class="RktSym">after-recurse-2</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">restore</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">assign</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">op</span><span class="hspace">&nbsp;</span><span class="RktSym">cdr</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">reg</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">save</span><span class="hspace">&nbsp;</span><span class="RktSym">val</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">goto</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">label</span><span class="hspace">&nbsp;</span><span class="RktSym">recurse-test</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktSym">after-recurse-2</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">restore</span><span class="hspace">&nbsp;</span><span class="RktSym">temp</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">assign</span><span class="hspace">&nbsp;</span><span class="RktSym">val</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">op</span><span class="hspace">&nbsp;</span><span class="RktSym">+</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">reg</span><span class="hspace">&nbsp;</span><span class="RktSym">val</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">reg</span><span class="hspace">&nbsp;</span><span class="RktSym">temp</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">restore</span><span class="hspace">&nbsp;</span><span class="RktSym">continue</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">goto</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">reg</span><span class="hspace">&nbsp;</span><span class="RktSym">continue</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktSym">base-case</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">assign</span><span class="hspace">&nbsp;</span><span class="RktSym">val</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">goto</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">reg</span><span class="hspace">&nbsp;</span><span class="RktSym">continue</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktSym">count-leaves-done</span></td></tr></table></blockquote><p>The instrumentation we did in the previous section makes it easy to watch how
this machine behaves:</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">&gt; (set-register-contents! recursive-count-leaves-machine 'tree '(1 (2 (3 4 (5) 6) 7)))</span></p></td></tr><tr><td><p><span class="stt">'done</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">&gt; (trace-register-on recursive-count-leaves-machine 'val)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">&gt; (trace-register-on recursive-count-leaves-machine 'tree)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">&gt; (start recursive-count-leaves-machine)</span></p></td></tr><tr><td><p><span class="stt">Assigning val from *unassigned* to 0</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (1 (2 (3 4 (5) 6) 7)) to 1</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 0 to 1</span></p></td></tr><tr><td><p><span class="stt">Restoring tree from 1 to (1 (2 (3 4 (5) 6) 7))</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (1 (2 (3 4 (5) 6) 7)) to ((2 (3 4 (5) 6) 7))</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from ((2 (3 4 (5) 6) 7)) to (2 (3 4 (5) 6) 7)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (2 (3 4 (5) 6) 7) to 2</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 1 to 1</span></p></td></tr><tr><td><p><span class="stt">Restoring tree from 2 to (2 (3 4 (5) 6) 7)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (2 (3 4 (5) 6) 7) to ((3 4 (5) 6) 7)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from ((3 4 (5) 6) 7) to (3 4 (5) 6)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (3 4 (5) 6) to 3</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 1 to 1</span></p></td></tr><tr><td><p><span class="stt">Restoring tree from 3 to (3 4 (5) 6)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (3 4 (5) 6) to (4 (5) 6)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (4 (5) 6) to 4</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 1 to 1</span></p></td></tr><tr><td><p><span class="stt">Restoring tree from 4 to (4 (5) 6)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (4 (5) 6) to ((5) 6)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from ((5) 6) to (5)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (5) to 5</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 1 to 1</span></p></td></tr><tr><td><p><span class="stt">Restoring tree from 5 to (5)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (5) to ()</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 1 to 0</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 0 to 1</span></p></td></tr><tr><td><p><span class="stt">Restoring tree from () to ((5) 6)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from ((5) 6) to (6)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (6) to 6</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 1 to 1</span></p></td></tr><tr><td><p><span class="stt">Restoring tree from 6 to (6)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (6) to ()</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 1 to 0</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 0 to 1</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 1 to 2</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 2 to 3</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 3 to 4</span></p></td></tr><tr><td><p><span class="stt">Restoring tree from () to ((3 4 (5) 6) 7)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from ((3 4 (5) 6) 7) to (7)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (7) to 7</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 4 to 1</span></p></td></tr><tr><td><p><span class="stt">Restoring tree from 7 to (7)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (7) to ()</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 1 to 0</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 0 to 1</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 1 to 5</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 5 to 6</span></p></td></tr><tr><td><p><span class="stt">Restoring tree from () to ((2 (3 4 (5) 6) 7))</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from ((2 (3 4 (5) 6) 7)) to ()</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 6 to 0</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 0 to 6</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 6 to 7</span></p></td></tr><tr><td><p><span class="stt">'done</span></p></td></tr></table></p><p>An iterative implementation is similar, but features a very prominent difference:
because the algorithm is tail-recursive, we don&rsquo;t need to perform any operations
after the second recursive call. The final return value should already be in the
<span class="stt">val</span> register. Much of the rest of the program is similar.</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">count-leaves</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">count-iter</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">cond</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">null?</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">not</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">pair?</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">+</span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="hspace">&nbsp;</span><span class="RktVal">1</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">else</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">count-iter</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">cdr</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">count-iter</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">car</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">count-iter</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktSym">start-machine</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">assign</span><span class="hspace">&nbsp;</span><span class="RktSym">continue</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">label</span><span class="hspace">&nbsp;</span><span class="RktSym">count-leaves-done</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">assign</span><span class="hspace">&nbsp;</span><span class="RktSym">val</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">assign</span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktSym">count-iter</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">test</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">op</span><span class="hspace">&nbsp;</span><span class="RktSym">null?</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">reg</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">branch</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">label</span><span class="hspace">&nbsp;</span><span class="RktSym">base-case</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">test</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">op</span><span class="hspace">&nbsp;</span><span class="RktSym">pair?</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">reg</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">branch</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">label</span><span class="hspace">&nbsp;</span><span class="RktSym">recurse</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">assign</span><span class="hspace">&nbsp;</span><span class="RktSym">val</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">op</span><span class="hspace">&nbsp;</span><span class="RktSym">+</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">reg</span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="hspace">&nbsp;</span><span class="RktVal">1</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">goto</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">reg</span><span class="hspace">&nbsp;</span><span class="RktSym">continue</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktSym">recurse</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">save</span><span class="hspace">&nbsp;</span><span class="RktSym">continue</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">assign</span><span class="hspace">&nbsp;</span><span class="RktSym">continue</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">label</span><span class="hspace">&nbsp;</span><span class="RktSym">after-recurse</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">save</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">assign</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">op</span><span class="hspace">&nbsp;</span><span class="RktSym">car</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">reg</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">goto</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">label</span><span class="hspace">&nbsp;</span><span class="RktSym">count-iter</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktSym">after-recurse</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">restore</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">assign</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">op</span><span class="hspace">&nbsp;</span><span class="RktSym">cdr</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">reg</span><span class="hspace">&nbsp;</span><span class="RktSym">tree</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">assign</span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">reg</span><span class="hspace">&nbsp;</span><span class="RktSym">val</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">restore</span><span class="hspace">&nbsp;</span><span class="RktSym">continue</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">goto</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">label</span><span class="hspace">&nbsp;</span><span class="RktSym">count-iter</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktSym">base-case</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">assign</span><span class="hspace">&nbsp;</span><span class="RktSym">val</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">reg</span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">goto</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">reg</span><span class="hspace">&nbsp;</span><span class="RktSym">continue</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktSym">count-leaves-done</span></td></tr></table></blockquote><p>Similarly, we can instrument this program and observe how it behaves:</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">&gt; (set-register-contents! iterative-count-leaves-machine 'tree '(1 (2 (3 4 (5) 6) 7)))</span></p></td></tr><tr><td><p><span class="stt">'done</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">&gt; (trace-register-on iterative-count-leaves-machine 'val)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">&gt; (trace-register-on iterative-count-leaves-machine 'tree)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">&gt; (trace-register-on iterative-count-leaves-machine 'n)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">&gt; (start iterative-count-leaves-machine)</span></p></td></tr><tr><td><p><span class="stt">Assigning val from *unassigned* to 0</span></p></td></tr><tr><td><p><span class="stt">Assigning n from *unassigned* to 0</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (1 (2 (3 4 (5) 6) 7)) to 1</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 0 to 1</span></p></td></tr><tr><td><p><span class="stt">Restoring tree from 1 to (1 (2 (3 4 (5) 6) 7))</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (1 (2 (3 4 (5) 6) 7)) to ((2 (3 4 (5) 6) 7))</span></p></td></tr><tr><td><p><span class="stt">Assigning n from 0 to 1</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from ((2 (3 4 (5) 6) 7)) to (2 (3 4 (5) 6) 7)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (2 (3 4 (5) 6) 7) to 2</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 1 to 2</span></p></td></tr><tr><td><p><span class="stt">Restoring tree from 2 to (2 (3 4 (5) 6) 7)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (2 (3 4 (5) 6) 7) to ((3 4 (5) 6) 7)</span></p></td></tr><tr><td><p><span class="stt">Assigning n from 1 to 2</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from ((3 4 (5) 6) 7) to (3 4 (5) 6)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (3 4 (5) 6) to 3</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 2 to 3</span></p></td></tr><tr><td><p><span class="stt">Restoring tree from 3 to (3 4 (5) 6)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (3 4 (5) 6) to (4 (5) 6)</span></p></td></tr><tr><td><p><span class="stt">Assigning n from 2 to 3</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (4 (5) 6) to 4</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 3 to 4</span></p></td></tr><tr><td><p><span class="stt">Restoring tree from 4 to (4 (5) 6)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (4 (5) 6) to ((5) 6)</span></p></td></tr><tr><td><p><span class="stt">Assigning n from 3 to 4</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from ((5) 6) to (5)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (5) to 5</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 4 to 5</span></p></td></tr><tr><td><p><span class="stt">Restoring tree from 5 to (5)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (5) to ()</span></p></td></tr><tr><td><p><span class="stt">Assigning n from 4 to 5</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 5 to 5</span></p></td></tr><tr><td><p><span class="stt">Restoring tree from () to ((5) 6)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from ((5) 6) to (6)</span></p></td></tr><tr><td><p><span class="stt">Assigning n from 5 to 5</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (6) to 6</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 5 to 6</span></p></td></tr><tr><td><p><span class="stt">Restoring tree from 6 to (6)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (6) to ()</span></p></td></tr><tr><td><p><span class="stt">Assigning n from 5 to 6</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 6 to 6</span></p></td></tr><tr><td><p><span class="stt">Restoring tree from () to ((3 4 (5) 6) 7)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from ((3 4 (5) 6) 7) to (7)</span></p></td></tr><tr><td><p><span class="stt">Assigning n from 6 to 6</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (7) to 7</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 6 to 7</span></p></td></tr><tr><td><p><span class="stt">Restoring tree from 7 to (7)</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from (7) to ()</span></p></td></tr><tr><td><p><span class="stt">Assigning n from 6 to 7</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 7 to 7</span></p></td></tr><tr><td><p><span class="stt">Restoring tree from () to ((2 (3 4 (5) 6) 7))</span></p></td></tr><tr><td><p><span class="stt">Assigning tree from ((2 (3 4 (5) 6) 7)) to ()</span></p></td></tr><tr><td><p><span class="stt">Assigning n from 7 to 7</span></p></td></tr><tr><td><p><span class="stt">Assigning val from 7 to 7</span></p></td></tr><tr><td><p><span class="stt">'done</span></p></td></tr></table></p><div class="navsetbottom"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="c5e20.html" title="backward to &quot;5.20 Exercise 5.20&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="Chapter_5.html" title="up to &quot;5 Chapter 5&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="c5e22.html" title="forward to &quot;5.22 Exercise 5.22&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div></body></html>