<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>5.17&nbsp;Exercise 5.17</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="racket.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript" src="manual-racket.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">zthomae&rsquo;s SICP solutions</a></td></tr></table></div><div class="tocviewsublisttop" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="Chapter_1.html" class="tocviewlink" data-pltdoc="x">Chapter 1</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="Chapter_2.html" class="tocviewlink" data-pltdoc="x">Chapter 2</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="Chapter_3.html" class="tocviewlink" data-pltdoc="x">Chapter 3</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="Chapter_4.html" class="tocviewlink" data-pltdoc="x">Chapter 4</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="Chapter_5.html" class="tocviewselflink" data-pltdoc="x">Chapter 5</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9660;</a></td><td>5&nbsp;</td><td><a href="Chapter_5.html" class="tocviewlink" data-pltdoc="x">Chapter 5</a></td></tr></table><div class="tocviewsublistbottom" style="display: block;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">5.1&nbsp;</td><td><a href="c5e0.html" class="tocviewlink" data-pltdoc="x">Note on diagrams</a></td></tr><tr><td align="right">5.2&nbsp;</td><td><a href="c5e2.html" class="tocviewlink" data-pltdoc="x">Exercise 5.2</a></td></tr><tr><td align="right">5.3&nbsp;</td><td><a href="c5e3.html" class="tocviewlink" data-pltdoc="x">Exercise 5.3</a></td></tr><tr><td align="right">5.4&nbsp;</td><td><a href="c5e4.html" class="tocviewlink" data-pltdoc="x">Exercise 5.4</a></td></tr><tr><td align="right">5.5&nbsp;</td><td><a href="c5e5.html" class="tocviewlink" data-pltdoc="x">Exercise 5.5</a></td></tr><tr><td align="right">5.6&nbsp;</td><td><a href="c5e6.html" class="tocviewlink" data-pltdoc="x">Exercise 5.6</a></td></tr><tr><td align="right">5.7&nbsp;</td><td><a href="c5e7.html" class="tocviewlink" data-pltdoc="x">Exercise 5.7</a></td></tr><tr><td align="right">5.8&nbsp;</td><td><a href="c5e8.html" class="tocviewlink" data-pltdoc="x">Exercise 5.8</a></td></tr><tr><td align="right">5.9&nbsp;</td><td><a href="c5e9.html" class="tocviewlink" data-pltdoc="x">Exercise 5.9</a></td></tr><tr><td align="right">5.10&nbsp;</td><td><a href="c5e10.html" class="tocviewlink" data-pltdoc="x">Exercise 5.10</a></td></tr><tr><td align="right">5.11&nbsp;</td><td><a href="c5e11.html" class="tocviewlink" data-pltdoc="x">Exercise 5.11</a></td></tr><tr><td align="right">5.12&nbsp;</td><td><a href="c5e12.html" class="tocviewlink" data-pltdoc="x">Exercise 5.12</a></td></tr><tr><td align="right">5.13&nbsp;</td><td><a href="c5e13.html" class="tocviewlink" data-pltdoc="x">Exercise 5.13</a></td></tr><tr><td align="right">5.14&nbsp;</td><td><a href="c5e14.html" class="tocviewlink" data-pltdoc="x">Exercise 5.14</a></td></tr><tr><td align="right">5.15&nbsp;</td><td><a href="c5e15.html" class="tocviewlink" data-pltdoc="x">Exercise 5.15</a></td></tr><tr><td align="right">5.16&nbsp;</td><td><a href="c5e16.html" class="tocviewlink" data-pltdoc="x">Exercise 5.16</a></td></tr><tr><td align="right">5.17&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Exercise 5.17</a></td></tr></table></div></div></div></div><div class="maincolumn"><div class="main"><div class="navsettop"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="c5e16.html" title="backward to &quot;5.16 Exercise 5.16&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="Chapter_5.html" title="up to &quot;5 Chapter 5&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<span class="nonavigation">next &rarr;</span></span>&nbsp;</div><h4>5.17<tt>&nbsp;</tt><a name="(part._c5e17)"></a>Exercise 5.17</h4><p>Printing labels alongside instructions is slightly trickier because we aren&rsquo;t
currently associating instructions with their preceding labels.</p><p>We could use an auxiliary data structure to store the associations between
instructions and labels (where applicable), but it seems a little cleaner
to me to expand the instruction type to optionally include a label. Since
the underlying data structure is hidden behind accessing functions, the change
should be relatively painless.</p><p><span class="stt">extract-labels</span> is procedure which iterates over the labels and instructions
in the program and separates them. One might assume that this is the best
location to associate instructions with their label(s), but this happens to
iterate over the instructions in reverse order. However, the iteration occurs in
reverse order. If labels are discovered after the instruction at which they
point, we need to be slightly more careful in how we track this.</p><p>I would still like to maintain the association between labels and instructions
by instrumenting <span class="stt">extract-labels</span>, because this is the function that is
canonically responsible for constructing both of these. The main change
that I need to make now is to maintain a reference to the <span style="font-style: italic">last</span>
instruction which I have created and add labels to it where necessary. In
essence, I can do this by adding a new argument to the internal function that
this uses.</p><p>First, here are the updated constructor/accessor functions for instructions:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">make-instruction</span><span class="hspace">&nbsp;</span><span class="RktSym">text</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">list</span><span class="hspace">&nbsp;</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">(</span><span class="RktVal">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">instruction-text</span><span class="hspace">&nbsp;</span><span class="RktSym">inst</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">car</span><span class="hspace">&nbsp;</span><span class="RktSym">inst</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">instruction-labels</span><span class="hspace">&nbsp;</span><span class="RktSym">inst</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">cadr</span><span class="hspace">&nbsp;</span><span class="RktSym">inst</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">instruction-execution-proc</span><span class="hspace">&nbsp;</span><span class="RktSym">inst</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">cddr</span><span class="hspace">&nbsp;</span><span class="RktSym">inst</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">add-instruction-label!</span><span class="hspace">&nbsp;</span><span class="RktSym">inst</span><span class="hspace">&nbsp;</span><span class="RktSym">label</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">set-cdr!</span><span class="hspace">&nbsp;</span><span class="RktSym">inst</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">cons</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">cons</span><span class="hspace">&nbsp;</span><span class="RktSym">label</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">instruction-labels</span><span class="hspace">&nbsp;</span><span class="RktSym">inst</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">instruction-execution-proc</span><span class="hspace">&nbsp;</span><span class="RktSym">inst</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">set-instruction-execution-proc!</span><span class="hspace">&nbsp;</span><span class="RktSym">inst</span><span class="hspace">&nbsp;</span><span class="RktSym">proc</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">set-cdr!</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">cdr</span><span class="hspace">&nbsp;</span><span class="RktSym">inst</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">proc</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>As you can see, the new representation is to include a list of labels as the
second item in a list, with the instruction text being first and the execution
procedure being last. This choice is arbitrary. (I&rsquo;ve not added the ability
to clear the labels that point to an instruction to the public interface.)</p><p>Next, here is the new definition of <span class="stt">extract-labels</span>. Note the new
argument to the internal procedure, and the fact that we only associate an
instruction with a new label if we have one.</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">extract-labels</span><span class="hspace">&nbsp;</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktSym">receive</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">if</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">null?</span><span class="hspace">&nbsp;</span><span class="RktSym">text</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">receive</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">(</span><span class="RktVal">)</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">(</span><span class="RktVal">)</span><span class="hspace">&nbsp;</span><span class="RktVal">#f</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">extract-labels</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">cdr</span><span class="hspace">&nbsp;</span><span class="RktSym">text</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">insts</span><span class="hspace">&nbsp;</span><span class="RktSym">labels</span><span class="hspace">&nbsp;</span><span class="RktSym">last-instruction</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">let</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">next-inst</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">car</span><span class="hspace">&nbsp;</span><span class="RktSym">text</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">if</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">symbol?</span><span class="hspace">&nbsp;</span><span class="RktSym">next-inst</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">if</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">assoc</span><span class="hspace">&nbsp;</span><span class="RktSym">next-inst</span><span class="hspace">&nbsp;</span><span class="RktSym">labels</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">error</span><span class="hspace">&nbsp;</span><span class="RktVal">"Duplicate label -- ASSEMBLE"</span><span class="hspace">&nbsp;</span><span class="RktSym">next-inst</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">begin</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">if</span><span class="hspace">&nbsp;</span><span class="RktSym">last-instruction</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">add-instruction-label!</span><span class="hspace">&nbsp;</span><span class="RktSym">last-instruction</span><span class="hspace">&nbsp;</span><span class="RktSym">next-inst</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">receive</span><span class="hspace">&nbsp;</span><span class="RktSym">insts</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">cons</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">make-label-entry</span><span class="hspace">&nbsp;</span><span class="RktSym">next-inst</span><span class="hspace">&nbsp;</span><span class="RktSym">insts</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">labels</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">last-instruction</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">let</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">next-instruction</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">make-instruction</span><span class="hspace">&nbsp;</span><span class="RktSym">next-inst</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">receive</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">cons</span><span class="hspace">&nbsp;</span><span class="RktSym">next-instruction</span><span class="hspace">&nbsp;</span><span class="RktSym">insts</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">labels</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">next-instruction</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p><span class="stt">assemble</span>, the only caller of this method, also needs to be modified:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">assemble</span><span class="hspace">&nbsp;</span><span class="RktSym">controller-text</span><span class="hspace">&nbsp;</span><span class="RktSym">machine</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">extract-labels</span><span class="hspace">&nbsp;</span><span class="RktSym">controller-text</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">insts</span><span class="hspace">&nbsp;</span><span class="RktSym">labels</span><span class="hspace">&nbsp;</span><span class="RktSym">last-instruction</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">update-insts!</span><span class="hspace">&nbsp;</span><span class="RktSym">insts</span><span class="hspace">&nbsp;</span><span class="RktSym">labels</span><span class="hspace">&nbsp;</span><span class="RktSym">machine</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">insts</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>Lastly, I can update <span class="stt">display-instruction</span> to also print the labels. For
legibility, I will unconditionally indent real instruction text to keep it
distinct from labels:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">display-instruction</span><span class="hspace">&nbsp;</span><span class="RktSym">inst</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">if</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">instruction-labels</span><span class="hspace">&nbsp;</span><span class="RktSym">inst</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">for-each</span><span class="hspace">&nbsp;</span><span class="RktSym">displayln</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">instruction-labels</span><span class="hspace">&nbsp;</span><span class="RktSym">inst</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">displayln</span><span class="hspace">&nbsp;</span><span class="RktVal">"</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktVal">"</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">car</span><span class="hspace">&nbsp;</span><span class="RktSym">inst</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>To see these changes in action, here&rsquo;s a modified version of the recursive
exponentiation machine which contains two labels above one of the instructions:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace">&nbsp;</span><span class="RktSym">recursive-exponentiation-machine</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">make-machine</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">list</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">list</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">=</span><span class="hspace">&nbsp;</span><span class="RktSym">=</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">list</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal"><span class="nobreak">-</span></span><span class="hspace">&nbsp;</span><span class="RktSym"><span class="nobreak">-</span></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">list</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">*</span><span class="hspace">&nbsp;</span><span class="RktSym">*</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">'</span><span class="RktVal">(</span><span class="RktVal">start-machine</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">perform</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">op</span><span class="hspace">&nbsp;</span><span class="RktVal">initialize-instruction-count</span><span class="RktVal">)</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">assign</span><span class="hspace">&nbsp;</span><span class="RktVal">continue</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">label</span><span class="hspace">&nbsp;</span><span class="RktVal">expt-done</span><span class="RktVal">)</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">expt-loop</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">other-label-expt-loop</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">test</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">op</span><span class="hspace">&nbsp;</span><span class="RktVal">=</span><span class="RktVal">)</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">reg</span><span class="hspace">&nbsp;</span><span class="RktVal">n</span><span class="RktVal">)</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">const</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktVal">)</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">branch</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">label</span><span class="hspace">&nbsp;</span><span class="RktVal">base-case</span><span class="RktVal">)</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">save</span><span class="hspace">&nbsp;</span><span class="RktVal">continue</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">assign</span><span class="hspace">&nbsp;</span><span class="RktVal">n</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">op</span><span class="hspace">&nbsp;</span><span class="RktVal"><span class="nobreak">-</span></span><span class="RktVal">)</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">reg</span><span class="hspace">&nbsp;</span><span class="RktVal">n</span><span class="RktVal">)</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">const</span><span class="hspace">&nbsp;</span><span class="RktVal">1</span><span class="RktVal">)</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">save</span><span class="hspace">&nbsp;</span><span class="RktVal">n</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">assign</span><span class="hspace">&nbsp;</span><span class="RktVal">continue</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">label</span><span class="hspace">&nbsp;</span><span class="RktVal">after-expt</span><span class="RktVal">)</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">goto</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">label</span><span class="hspace">&nbsp;</span><span class="RktVal">expt-loop</span><span class="RktVal">)</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">after-expt</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">restore</span><span class="hspace">&nbsp;</span><span class="RktVal">n</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">restore</span><span class="hspace">&nbsp;</span><span class="RktVal">continue</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">assign</span><span class="hspace">&nbsp;</span><span class="RktVal">val</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">op</span><span class="hspace">&nbsp;</span><span class="RktVal">*</span><span class="RktVal">)</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">reg</span><span class="hspace">&nbsp;</span><span class="RktVal">b</span><span class="RktVal">)</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">reg</span><span class="hspace">&nbsp;</span><span class="RktVal">val</span><span class="RktVal">)</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">goto</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">reg</span><span class="hspace">&nbsp;</span><span class="RktVal">continue</span><span class="RktVal">)</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">base-case</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">assign</span><span class="hspace">&nbsp;</span><span class="RktVal">val</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">const</span><span class="hspace">&nbsp;</span><span class="RktVal">1</span><span class="RktVal">)</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">goto</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">reg</span><span class="hspace">&nbsp;</span><span class="RktVal">continue</span><span class="RktVal">)</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">expt-done</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">perform</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">op</span><span class="hspace">&nbsp;</span><span class="RktVal">print-instruction-count</span><span class="RktVal">)</span><span class="RktVal">)</span><span class="RktVal">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>And in use:</p><p><table cellspacing="0" cellpadding="0"><tr><td><p><span class="stt">&gt; (set-register-contents! recursive-exponentiation-machine 'b 2)</span></p></td></tr><tr><td><p><span class="stt">'done</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">&gt; (set-register-contents! recursive-exponentiation-machine 'n 2)</span></p></td></tr><tr><td><p><span class="stt">'done</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">&gt; (trace-on recursive-exponentiation-machine)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">&gt; (start recursive-exponentiation-machine)</span></p></td></tr><tr><td><p><span class="stt">start-machine</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(perform (op initialize-instruction-count))</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(assign continue (label expt-done))</span></p></td></tr><tr><td><p><span class="stt">expt-loop</span></p></td></tr><tr><td><p><span class="stt">other-label-expt-loop</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(test (op =) (reg n) (const 0))</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(branch (label base-case))</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(save continue)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(assign n (op -) (reg n) (const 1))</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(save n)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(assign continue (label after-expt))</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(goto (label expt-loop))</span></p></td></tr><tr><td><p><span class="stt">expt-loop</span></p></td></tr><tr><td><p><span class="stt">other-label-expt-loop</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(test (op =) (reg n) (const 0))</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(branch (label base-case))</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(save continue)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(assign n (op -) (reg n) (const 1))</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(save n)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(assign continue (label after-expt))</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(goto (label expt-loop))</span></p></td></tr><tr><td><p><span class="stt">expt-loop</span></p></td></tr><tr><td><p><span class="stt">other-label-expt-loop</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(test (op =) (reg n) (const 0))</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(branch (label base-case))</span></p></td></tr><tr><td><p><span class="stt">base-case</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(assign val (const 1))</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(goto (reg continue))</span></p></td></tr><tr><td><p><span class="stt">after-expt</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(restore n)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(restore continue)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(assign val (op *) (reg b) (reg val))</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(goto (reg continue))</span></p></td></tr><tr><td><p><span class="stt">after-expt</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(restore n)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(restore continue)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(assign val (op *) (reg b) (reg val))</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(goto (reg continue))</span></p></td></tr><tr><td><p><span class="stt">expt-done</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">(perform (op print-instruction-count))</span></p></td></tr><tr><td><p><span class="stt">instruction-count = 28</span></p></td></tr><tr><td><p><span class="stt">'done</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">&gt; (get-register-contents recursive-exponentiation-machine 'val)</span></p></td></tr><tr><td><p><span class="stt">4</span></p></td></tr></table></p><p>As you can see, the result and the instruction counts are both identical, and
the instructions have been traced correctly.</p><div class="navsetbottom"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="c5e16.html" title="backward to &quot;5.16 Exercise 5.16&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="Chapter_5.html" title="up to &quot;5 Chapter 5&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<span class="nonavigation">next &rarr;</span></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div></body></html>